<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Response Map ‚Äî Hydrants + Routing + Follow</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <!-- Geocoder (Nominatim) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <!-- Fast spatial index for k-nearest -->
  <script src="https://unpkg.com/kdbush@4.0.2/kdbush.min.js"></script>
  <script src="https://unpkg.com/geokdbush@4.0.0/geokdbush.min.js"></script>
  <style>
    :root{ --bg:#0b1020;--panel:#111831;--ink:#eef3ff;--muted:#b7c2e1;--accent:#4da3ff;--ok:#17cf7d;--warn:#ffb020; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .app{display:grid;grid-template-rows:auto 1fr; height:100%;}
    header{position:sticky;top:0;z-index:1000;display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;padding:.5rem .75rem;border-bottom:1px solid #1b2551;background:linear-gradient(180deg,#0c1430,#0b1020)}
    header .brand{font-weight:800;letter-spacing:.3px}
    header .timer{margin-left:auto;background:#0f1733;border:1px solid #1b2551;border-radius:12px;padding:.3rem .6rem;font-variant-numeric:tabular-nums}
    header .btn{background:#0f1733;border:1px solid #1b2551;color:var(--ink);border-radius:10px;padding:.35rem .6rem;cursor:pointer}
    header .btn.primary{background:var(--accent);border-color:#2c7bd9;color:#051026;font-weight:700}

    .main{display:grid;grid-template-columns:1fr 340px;height:calc(100vh - 56px)}
    /* When panel collapsed on desktop */
    .main.full{grid-template-columns:1fr 0 !important;}
    #map{width:100%;height:100%}

    aside{height:100%;overflow:auto;background:var(--panel);border-left:1px solid #1b2551;transition:transform .25s ease}
    aside.collapsed{transform:translateX(100%)}
    .pane{padding:.8rem;border-bottom:1px solid #1b2551}
    .pane h3{margin:.2rem 0 .6rem 0;font-size:1rem}
    .small{font-size:.82rem;color:var(--muted)}
    .list{display:grid;gap:.5rem}
    .card{border:1px solid #22306a;background:#0f1733;border-radius:14px;padding:.5rem .6rem}
    .row{display:flex;justify-content:space-between;gap:.5rem;align-items:center}
    .tag{font-size:.7rem;color:#cfe1ff;background:#162352;border:1px solid #22306a;border-radius:999px;padding:.2rem .5rem}
    .input{width:100%;padding:.45rem .6rem;border-radius:10px;border:1px solid #1b2551;background:#0c1430;color:var(--ink)}
    .bar{display:flex;gap:.4rem;align-items:center;flex-wrap:wrap}

    .toggle-panel{position:absolute;right:12px;top:12px;z-index:500;background:#0f1733;border:1px solid #1b2551;border-radius:12px;padding:.35rem .6rem;cursor:pointer}

    .leaflet-control-geocoder{border-radius:12px;overflow:hidden}
    .leaflet-popup-content{color:#001}
    .start-pin{background:#17cf7d; border:2px solid #fff; width:16px; height:16px; border-radius:50%; box-shadow:0 0 0 2px rgba(23,207,125,.25)}
    .num-icon{background:#4da3ff;border-radius:999px;border:2px solid #fff;box-shadow:0 0 0 2px rgba(77,163,255,.3);line-height:20px;text-align:center;color:#001;font-weight:800}

    @media (max-width: 900px){
      .main{grid-template-columns:1fr}
      aside{position:fixed;inset:auto 0 0 0;width:100%;max-height:70vh;border-left:none;border-top:1px solid #1b2551;transform:translateY(100%)}
      aside.open{transform:translateY(0)}
      .toggle-panel{right:12px;top:auto;bottom:12px}
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">Response Map</div>
    <button id="panelToggle" class="btn">Panel</button>
    <button id="routeIncidentBtn" class="btn">Route to incident</button>
    <button id="followBtn" class="btn">Follow me</button>
    <button id="timerBtn" class="btn">Start timer</button>
    <div id="timer" class="timer">00:00:00</div>
  </header>

  <div class="main">
    <div id="map">
      <button id="floatingToggle" class="toggle-panel">Panel</button>
    </div>

    <aside id="side" class="collapsed">
      <div class="pane">
        <h3>Incident</h3>
        <div class="bar">
          <input id="incidentInput" class="input" type="text" placeholder="Type incident location (address, block, POI)" />
          <button id="incidentGo" class="btn primary">Go</button>
        </div>
        <div class="bar">
          <button id="locateBtn" class="btn">Use my location</button>
          <button id="clickBtn" class="btn">Click on map</button>
          <select id="nearestCount" class="input" style="width:auto">
            <option>3</option><option selected>5</option><option>10</option><option>20</option>
          </select>
          <button id="nearestBtn" class="btn">Nearest</button>
        </div>
        <div class="bar">
          <a id="gmapsIncident" class="btn" target="_blank" rel="noopener" href="#">Navigate in Google Maps</a>
        </div>
        <div class="small">Set the incident, then route to it. Hydrants remain visible during navigation.</div>
      </div>

      <div class="pane">
        <h3>Hydrant search</h3>
        <input id="hydrantSearch" class="input" list="hydrantList" placeholder="Search HYD_ID‚Ä¶" />
        <datalist id="hydrantList"></datalist>
        <div class="small">Type a hydrant ID and pick from the dropdown to zoom. All hydrants stay visible.</div>
      </div>

      <div class="pane">
        <h3>Nearest hydrants</h3>
        <div id="nearestList" class="list small"></div>
      </div>
    </aside>
  </div>
</div>

<script>
// ===== CONFIG =====
const DATA_SOURCES = [ { name: 'Hydrants', url: 'hydrants.geojson', idField: 'HYD_ID', addrField: 'LOCATION' } ];
const PROP_LABELS = ['HYD_ID','hydrant_id','id','name','AssetID'];

// ===== MAP CORE =====
const map = L.map('map', { preferCanvas:true }).setView([1.3521,103.8198], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20, attribution: '&copy; OpenStreetMap' }).addTo(map);
const cluster = L.markerClusterGroup({ showCoverageOnHover:false, chunkedLoading:true });
let allPoints=[]; let index=null; let startMarker=null; let nearestMarkers=[]; let routeLine=null; let clickMode=false;
const startIcon = L.divIcon({ className:'start-pin', iconSize:[16,16] });
const hydrantIcon = L.icon({ iconUrl:'hydrant.svg', iconSize:[30,30], iconAnchor:[15,30], popupAnchor:[0,-28] });
const userIcon = L.divIcon({ className:'', html:'<div style="width:14px;height:14px;border-radius:50%;background:#4da3ff;border:2px solid #fff;box-shadow:0 0 0 2px rgba(77,163,255,.3)"></div>' });

function fmt(n){ return Intl.NumberFormat('en-SG',{maximumFractionDigits:1}).format(n); }
function haversine(a,b,c,d){const R=6371e3;const t=x=>x*Math.PI/180;const dLat=t(c-a), dLon=t(d-b);const A=Math.sin(dLat/2)**2+Math.cos(t(a))*Math.cos(t(c))*Math.sin(dLon/2)**2;return 2*R*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));}
function pickProp(props, keys, fallback='‚Äì'){ for(const k of keys){ if(props && props[k]!=null && props[k]!=='' ) return props[k]; } return fallback; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

// ===== Panel toggle (desktop + mobile) =====
const side=document.getElementById('side');
const mainEl=document.querySelector('.main');
function panelToggle(){
  if(window.matchMedia('(max-width:900px)').matches){ side.classList.toggle('open'); }
  else { const collapsed=side.classList.toggle('collapsed'); mainEl.classList.toggle('full', collapsed); }
  setTimeout(()=>map.invalidateSize(),320);
}
document.getElementById('panelToggle').addEventListener('click', panelToggle);
const ft=document.getElementById('floatingToggle'); if(ft){ ft.addEventListener('click', panelToggle); }

// ===== Timer =====
let timerId=null; let startTs=null;
function formatDur(ms){ const s=Math.floor(ms/1000); const h=String(Math.floor(s/3600)).padStart(2,'0'); const m=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${h}:${m}:${ss}`; }
function startTimer(){ if(timerId) return; startTs=Date.now(); timerId=setInterval(()=>{ document.getElementById('timer').textContent=formatDur(Date.now()-startTs); },1000); document.getElementById('timerBtn').textContent='Running‚Ä¶'; }
function resetTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } document.getElementById('timer').textContent='00:00:00'; document.getElementById('timerBtn').textContent='Start timer'; }
document.getElementById('timerBtn').addEventListener('click', ()=>{ if(timerId){ resetTimer(); } else { startTimer(); } });

function setStartPoint(latlng,label='üìç Incident'){
  if(startMarker) startMarker.remove();
  startMarker=L.marker(latlng,{icon:startIcon}).addTo(map).bindPopup(`<b>${label}</b>`).openPopup();
  startTimer();
  updateGmapsIncidentLink();
}

// ===== Controls =====
map.on('click', e=>{ if(!clickMode) return; setStartPoint(e.latlng,'üìç Clicked'); clickMode=false; document.getElementById('clickBtn').classList.remove('primary'); });
document.getElementById('clickBtn').addEventListener('click', ()=>{ clickMode=!clickMode; document.getElementById('clickBtn').classList.toggle('primary', clickMode); });
document.getElementById('locateBtn').addEventListener('click', ()=>{ if(!('geolocation' in navigator)) return alert('No geolocation'); navigator.geolocation.getCurrentPosition(pos=>{const ll=[pos.coords.latitude,pos.coords.longitude]; setStartPoint(ll,'üìç My location'); map.setView(ll,16);}); });

document.getElementById('incidentGo').addEventListener('click', async ()=>{
  const q=document.getElementById('incidentInput').value.trim(); if(!q) return;
  const url=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&addressdetails=0&limit=1`;
  try{ const r=await fetch(url,{headers:{'Accept-Language':'en'}}); const j=await r.json(); if(!j.length) return alert('Location not found'); const p=j[0]; const ll=[parseFloat(p.lat), parseFloat(p.lon)]; setStartPoint(ll, `üìç ${escapeHtml(q)}`); map.setView(ll, 16); autoNearest(); }
  catch(e){ alert('Search failed. Try again.'); }
});

// ===== Nearest hydrants =====
function clearNearest(){ nearestMarkers.forEach(m=>m.remove()); nearestMarkers=[]; if(routeLine){ routeLine.remove(); routeLine=null; } document.getElementById('nearestList').innerHTML=''; }
function autoNearest(){ const k=parseInt(document.getElementById('nearestCount').value,10); findNearest(k,true); }
document.getElementById('nearestBtn').addEventListener('click', ()=>{ const k=parseInt(document.getElementById('nearestCount').value,10); findNearest(k,false); });

function findNearest(k=5, autoroute=false){
  if(!startMarker) return alert('Set an incident first.');
  if(!index) return alert('Hydrants not loaded yet.');
  clearNearest();
  const origin=startMarker.getLatLng();
  const items=geokdbush.around(index, origin.lng, origin.lat, Math.max(k,1));
  const list=document.getElementById('nearestList');
  items.slice(0,k).forEach((p,i)=>{
    const d = haversine(origin.lat,origin.lng,p.lat,p.lon);
    const numIcon = L.divIcon({className:'num-icon',html:String(i+1),iconSize:[24,24]});
    const mk=L.marker([p.lat,p.lon],{icon:numIcon}).addTo(map);
    nearestMarkers.push(mk);
    mk.bindPopup(`<b>Hydrant #${i+1}</b><div style='color:#345'>${escapeHtml(labelOf(p.feature))}</div><div>${fmt(d)} m</div>`);
    const el=document.createElement('div'); el.className='card';
    el.innerHTML=`<div class='row'><div><span class='tag'>#${i+1}</span> ${escapeHtml(labelOf(p.feature))}</div><div class='tag'>${fmt(d)} m</div></div>
      <div class='row' style='margin-top:.4rem'>
        <button class='btn' data-i='${i}'>Route to hydrant</button>
        <a class='btn' style='text-decoration:none' target='_blank' rel='noopener' href='${gmapLink(origin, L.latLng(p.lat,p.lon))}'>GMaps</a>
      </div>`;
    list.appendChild(el);
  });
  list.querySelectorAll('button[data-i]').forEach(btn=>btn.addEventListener('click',e=>{ const idx=+e.currentTarget.getAttribute('data-i'); routeTo(items[idx]); }));
  if(autoroute && items.length){ routeTo(items[0]); if(window.matchMedia('(max-width:900px)').matches){ side.classList.remove('open'); } }
}

function labelOf(feat){ return pickProp(feat.properties, PROP_LABELS, 'Hydrant'); }
function gmapLink(a,b){ return `https://www.google.com/maps/dir/?api=1&origin=${a.lat},${a.lng}&destination=${b.lat},${b.lng}&travelmode=driving`; }

async function routeTo(p){
  const a=startMarker.getLatLng(), b=L.latLng(p.lat,p.lon);
  const url=`https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
  try{ const res=await fetch(url); if(!res.ok) throw new Error('Routing error'); const json=await res.json(); if(json.code!=='Ok'||!json.routes?.length) throw new Error('No route'); const r=json.routes[0]; if(routeLine) routeLine.remove(); routeLine=L.geoJSON(r.geometry,{style:{weight:6,opacity:.95}}).addTo(map); map.fitBounds(routeLine.getBounds().pad(0.1)); } catch(e){ alert('OSRM demo may be rate-limited. Use Google Maps link.'); }
}

// ===== Route to incident from current GPS =====
async function routeToIncident(){
  if(!startMarker) return alert('Set an incident first.');
  if(!('geolocation' in navigator)) return alert('No GPS available');
  navigator.geolocation.getCurrentPosition(async pos=>{
    const a={lat:pos.coords.latitude,lng:pos.coords.longitude}; const b=startMarker.getLatLng();
    await routeFromAToB(a,b);
  }, ()=> alert('Could not get GPS location.'), {enableHighAccuracy:true,timeout:10000,maximumAge:60000});
}
document.getElementById('routeIncidentBtn').addEventListener('click', routeToIncident);

async function routeFromAToB(a,b){
  const url=`https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
  try{ const res=await fetch(url); if(!res.ok) throw new Error('Routing error'); const json=await res.json(); if(json.code!=='Ok'||!json.routes?.length) throw new Error('No route'); const r=json.routes[0]; if(routeLine) routeLine.remove(); routeLine=L.geoJSON(r.geometry,{style:{weight:6,opacity:.95}}).addTo(map); map.fitBounds(routeLine.getBounds().pad(0.1)); } catch(e){ console.warn(e); }
}

function updateGmapsIncidentLink(){
  const aTag=document.getElementById('gmapsIncident');
  if(!startMarker){ aTag.href='#'; return; }
  if('geolocation' in navigator){
    navigator.geolocation.getCurrentPosition(pos=>{
      const a={lat:pos.coords.latitude,lng:pos.coords.longitude}; const b=startMarker.getLatLng();
      aTag.href=gmapLink(a,b)+"&dir_action=navigate";
    },()=>{ const b=startMarker.getLatLng(); aTag.href=`https://www.google.com/maps/dir/?api=1&destination=${b.lat},${b.lng}&travelmode=driving&dir_action=navigate`; },{enableHighAccuracy:true,timeout:5000,maximumAge:60000});
  } else {
    const b=startMarker.getLatLng(); aTag.href=`https://www.google.com/maps/dir/?api=1&destination=${b.lat},${b.lng}&travelmode=driving&dir_action=navigate`;
  }
}

// ===== Hydrant search by ID (datalist) =====
const hydrantInput = document.getElementById('hydrantSearch');
hydrantInput.addEventListener('change', ()=>{
  const val = hydrantInput.value.trim(); if(!val) return;
  const found = allPoints.find(p=> String(labelOf(p.feature)).toLowerCase() === val.toLowerCase());
  if(found){ map.setView([found.lat, found.lon], 18); found.marker.openPopup(); }
});

// ===== Load hydrants =====
async function loadGeoJSON(src){
  const r=await fetch(src.url); if(!r.ok) throw new Error(`Load failed ${src.name}`); const gj=await r.json(); let count=0;
  const layer=L.geoJSON(gj,{ pointToLayer:(f,ll)=>L.marker(ll,{icon:hydrantIcon}), onEachFeature:(f,l)=>{ const id=src.idField?(f.properties?.[src.idField]??'Hydrant'):labelOf(f); const addr=src.addrField?(f.properties?.[src.addrField]??''):''; const addrLine=addr?`<div style='color:#345'>${escapeHtml(addr)}</div>`:''; l.bindPopup(`<b>${escapeHtml(id)}</b>${addrLine}`);} });
  layer.eachLayer(m=>{const ll=m.getLatLng(); allPoints.push({lat:ll.lat,lon:ll.lng,marker:m,feature:m.feature}); count++;});
  cluster.addLayer(layer); map.addLayer(cluster);
  // datalist for hydrant IDs
  const list=document.getElementById('hydrantList');
  const frag=document.createDocumentFragment();
  allPoints.forEach(p=>{ const opt=document.createElement('option'); opt.value=String(labelOf(p.feature)); frag.appendChild(opt); });
  list.innerHTML=''; list.appendChild(frag);
  index = geokdbush.index(allPoints, p=>p.lon, p=>p.lat);
  if(allPoints.length){ map.fitBounds(cluster.getBounds().pad(0.05)); }
  return count;
}

loadGeoJSON(DATA_SOURCES[0]);

// ===== Follow mode (continuous re-route) =====
let watchId=null; let userMarker=null; let accuracyCircle=null; let lastFollowRouteTs=0;
function updateUserMarker(a, acc){
  if(!userMarker){ userMarker=L.marker([a.lat,a.lng],{icon:userIcon}).addTo(map); }
  else { userMarker.setLatLng([a.lat,a.lng]); }
  if(acc!=null){
    const r = Math.max(10, Math.min(acc, 200));
    if(!accuracyCircle){ accuracyCircle = L.circle([a.lat,a.lng], {radius:r, color:'#4da3ff', weight:1, fillOpacity:0.08}).addTo(map); }
    else { accuracyCircle.setLatLng([a.lat,a.lng]); accuracyCircle.setRadius(r); }
  }
}
function startFollow(){
  if(!startMarker) return alert('Set an incident first.');
  if(!('geolocation' in navigator)) return alert('No GPS available');
  if(watchId) return; // already
  const btn=document.getElementById('followBtn'); btn.textContent='Following‚Ä¶';
  watchId = navigator.geolocation.watchPosition(pos=>{
    const a={lat:pos.coords.latitude,lng:pos.coords.longitude};
    updateUserMarker(a, pos.coords.accuracy);
    if(Date.now()-lastFollowRouteTs>5000){ lastFollowRouteTs=Date.now(); routeFromAToB(a, startMarker.getLatLng()); }
  }, err=>{ console.warn(err); stopFollow(); alert('GPS lost'); }, {enableHighAccuracy:true,timeout:20000,maximumAge:1000});
}
function stopFollow(){ if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; } document.getElementById('followBtn').textContent='Follow me'; }

document.getElementById('followBtn').addEventListener('click', ()=>{ if(watchId) stopFollow(); else startFollow(); });
</script>
</body>
</html>
