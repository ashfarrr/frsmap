<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Response Map — Hydrants + Nearest Route</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/kdbush@4.0.2/kdbush.min.js"></script>
  <script src="https://unpkg.com/geokdbush@4.0.0/geokdbush.min.js"></script>
  <style>
    :root{ --bg:#0b1020;--panel:#111831;--ink:#eef3ff;--muted:#b7c2e1;--accent:#4da3ff; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .app{display:grid;grid-template-rows:auto 1fr; height:100%}
    header{position:sticky;top:0;z-index:1000;display:flex;gap:.5rem;align-items:center;padding:.5rem .75rem;border-bottom:1px solid #1b2551;background:#0c1430}
    header .brand{font-weight:800}
    header .timer{margin-left:auto;background:#0f1733;border:1px solid #1b2551;border-radius:12px;padding:.3rem .6rem;font-variant-numeric:tabular-nums}
    header .btn{background:#0f1733;border:1px solid #1b2551;color:var(--ink);border-radius:10px;padding:.35rem .6rem;cursor:pointer}
    header .btn.primary{background:var(--accent);border-color:#2c7bd9;color:#051026;font-weight:700}
    .main{display:grid;grid-template-columns:1fr 340px;height:calc(100vh - 56px)}
    .main.full{grid-template-columns:1fr 0!important}
    #map{width:100%;height:100%}
    aside{height:100%;overflow:auto;background:var(--panel);border-left:1px solid #1b2551;transition:transform .25s ease}
    aside.collapsed{transform:translateX(100%)}
    .pane{padding:.8rem;border-bottom:1px solid #1b2551}
    .pane h3{margin:.2rem 0 .6rem 0;font-size:1rem}
    .input{width:100%;padding:.45rem .6rem;border-radius:10px;border:1px solid #1b2551;background:#0c1430;color:var(--ink)}
    .bar{display:flex;gap:.4rem;align-items:center;flex-wrap:wrap}
    @media(max-width:900px){.main{grid-template-columns:1fr}aside{position:fixed;inset:auto 0 0 0;width:100%;max-height:70vh;border-left:none;border-top:1px solid #1b2551;transform:translateY(100%)}aside.open{transform:translateY(0)}}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">Response Map</div>
    <button id="panelToggle" class="btn">Panel</button>
    <button id="timerBtn" class="btn">Start timer</button>
    <div id="timer" class="timer">00:00:00</div>
  </header>
  <div class="main">
    <div id="map"></div>
    <aside id="side" class="collapsed">
      <div class="pane">
        <h3>Incident</h3>
        <div class="bar">
          <input id="incidentInput" class="input" type="text" placeholder="Type incident location" />
          <button id="incidentGo" class="btn primary">Route to incident</button>
        </div>
      </div>
    </aside>
  </div>
</div>
<script>
const map=L.map('map').setView([1.3521,103.8198],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20}).addTo(map);
let startMarker=null;let routeLine=null;let watchId=null;
const startIcon=L.divIcon({className:'start-pin',iconSize:[16,16]});
function startTimer(){if(timerId)return;startTs=Date.now();timerId=setInterval(()=>{document.getElementById('timer').textContent=formatDur(Date.now()-startTs)},1000);}
function formatDur(ms){const s=Math.floor(ms/1000);const h=String(Math.floor(s/3600)).padStart(2,'0');const m=String(Math.floor((s%3600)/60)).padStart(2,'0');const ss=String(s%60).padStart(2,'0');return`${h}:${m}:${ss}`}
let timerId=null,startTs=null;
function setStartPoint(latlng,label='📍 Incident'){if(startMarker)startMarker.remove();startMarker=L.marker(latlng,{icon:startIcon}).addTo(map).bindPopup(label).openPopup();startTimer();autoFollow();openGmaps(latlng);}
document.getElementById('incidentGo').addEventListener('click', async () => {
  const q = document.getElementById('incidentInput').value.trim();
  if (!q) return;
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
  try {
    const r = await fetch(url);
    const j = await r.json();
    if (!j.length) return alert('Not found');
    const p = j[0];
    const dest = { lat: parseFloat(p.lat), lng: parseFloat(p.lon) };
    setStartPoint([dest.lat, dest.lng], `📍 ${q}`);
    map.setView([dest.lat, dest.lng], 16);
    autoNearest();

    // Auto-start Follow mode if available
    if (typeof startFollow === 'function') startFollow();

    // Auto-open Google Maps turn-by-turn
    const openGMaps = (origin) => {
      const gm = `https://www.google.com/maps/dir/?api=1&origin=${origin.lat},${origin.lng}&destination=${dest.lat},${dest.lng}&travelmode=driving&dir_action=navigate`;
      window.open(gm, '_blank');
    };
    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(pos => openGMaps({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
        () => window.open(`https://www.google.com/maps/dir/?api=1&destination=${dest.lat},${dest.lng}&travelmode=driving&dir_action=navigate`, '_blank'),
        { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 });
    } else {
      window.open(`https://www.google.com/maps/dir/?api=1&destination=${dest.lat},${dest.lng}&travelmode=driving&dir_action=navigate`, '_blank');
    }
  } catch (e) {
    alert('Search failed');
  }
});
function openGmaps(dest){if(!('geolocation'in navigator))return;navigator.geolocation.getCurrentPosition(pos=>{const a={lat:pos.coords.latitude,lng:pos.coords.longitude};window.open(`https://www.google.com/maps/dir/?api=1&origin=${a.lat},${a.lng}&destination=${dest[0]},${dest[1]}&travelmode=driving&dir_action=navigate`,'_blank');});}
function autoFollow(){if(!('geolocation'in navigator))return; if(watchId)return;watchId=navigator.geolocation.watchPosition(pos=>{const a={lat:pos.coords.latitude,lng:pos.coords.longitude};if(startMarker){routeFromAToB(a,startMarker.getLatLng());}},()=>{}, {enableHighAccuracy:true,timeout:20000,maximumAge:1000});}
async function routeFromAToB(a,b){const url=`https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;const res=await fetch(url);const json=await res.json();if(json.routes?.length){if(routeLine)routeLine.remove();routeLine=L.geoJSON(json.routes[0].geometry,{style:{weight:6,opacity:.95}}).addTo(map);}}
</script>
</body>
</html>
