<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SG Hydrants ‚Äî Nearest & Routing (CSV wired)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/kdbush@4.0.2/kdbush.min.js"></script>
  <script src="https://unpkg.com/geokdbush@4.0.0/geokdbush.min.js"></script>
  <style>
    :root{ --bg:#0b1020; --panel:#111831; --ink:#eef3ff; --muted:#b7c2e1; --accent:#4da3ff; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .app{display:grid;grid-template-rows:auto 1fr;height:100%}
    header{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;padding:.75rem 1rem;border-bottom:1px solid #1b2551;background:linear-gradient(180deg,#0c1430,#0b1020)}
    header h1{margin:0;font-size:1.05rem;font-weight:700}
    .controls{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin-left:auto}
    .controls .group{display:flex;gap:.35rem;align-items:center;background:#0f1733;border:1px solid #1b2551;border-radius:14px;padding:.35rem .5rem}
    .controls label{font-size:.8rem;color:var(--muted)}
    .controls select,.controls button{background:#0c1430;color:var(--ink);border:1px solid #1b2551;border-radius:10px;padding:.35rem .6rem;font-size:.85rem}
    .controls button.primary{background:var(--accent);border-color:#2c7bd9;color:#051026;font-weight:700}
    .controls button.ghost{background:transparent;border-color:#1b2551}
    .main{display:grid;grid-template-columns:1fr 320px;height:calc(100vh - 62px)}
    #map{width:100%;height:100%}
    aside{height:100%;overflow:auto;background:var(--panel);border-left:1px solid #1b2551}
    .pane{padding:1rem;border-bottom:1px solid #1b2551}
    .pane h3{margin:.2rem 0 .6rem 0;font-size:1rem}
    .small{font-size:.82rem;color:var(--muted)}
    .list{display:grid;gap:.5rem}
    .card{border:1px solid #22306a;background:#0f1733;border-radius:14px;padding:.5rem .6rem}
    .row{display:flex;justify-content:space-between;gap:.5rem}
    .tag{font-size:.7rem;color:#cfe1ff;background:#162352;border:1px solid #22306a;border-radius:999px;padding:.2rem .5rem}
    .num{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;font-size:.8rem;font-weight:700;background:#1e2c63;border:1px solid #324b9e}
    .leaflet-popup-content{color:#001}
    .start-pin{background:#17cf7d; border:2px solid #fff; width:16px; height:16px; border-radius:50%; box-shadow:0 0 0 2px rgba(23,207,125,.25)}
    .num-icon{background:#4da3ff;border-radius:999px;border:2px solid #fff;box-shadow:0 0 0 2px rgba(77,163,255,.3);line-height:20px;text-align:center;color:#001;font-weight:800}
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>SG Hydrants ‚Äî Nearest & Routing</h1>
    <div class="controls">
      <div class="group"><label>Nearest:</label><select id="nearestCount"><option>3</option><option selected>5</option><option>10</option><option>20</option></select></div>
      <div class="group"><button id="locateBtn">Use my location</button><button id="clickBtn" class="ghost">Click to set</button></div>
      <div class="group"><button id="nearestBtn" class="primary">Find nearest</button><button id="clearBtn">Clear</button></div>
    </div>
  </header>
  <div class="main">
    <div id="map"></div>
    <aside>
      <div class="pane small"><h3>How to use</h3>1) Place the <code>hydrants.geojson</code> file next to this HTML (or under <code>data/</code> if you change the URL). 2) Set an incident point. 3) Find nearest hydrants. 4) Route or open Google Maps.</div>
      <div class="pane small"><h3>Nearest hydrants</h3><div id="nearestList" class="list"></div></div>
      <div class="pane small"><h3>Layers loaded</h3><div id="layerStatus">Loading‚Ä¶</div></div>
    </aside>
  </div>
</div>

<script>
// ===== DATA SOURCE (wired to your CSV converted to GeoJSON) =====
const DATA_SOURCES = [
  { name: 'Hydrants (All)', url: 'hydrants.geojson', format: 'geojson', idField: 'HYD_ID', addrField: 'LOCATION' }
];

const PROP_LABELS = ['HYD_ID','hydrant_id','id','name','AssetID'];
const PROP_ADDR   = ['LOCATION','address','Address','LOCATION','location','ROAD_NAME'];

// ===== MAP CORE =====
const map = L.map('map', { preferCanvas: true }).setView([1.3521,103.8198], 12);
const base = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20, attribution: '&copy; OpenStreetMap' }).addTo(map);
const cluster = L.markerClusterGroup({ showCoverageOnHover:false, chunkedLoading:true });

let allPoints=[]; let index=null; let startMarker=null; let nearestMarkers=[]; let routeLine=null; let clickMode=false;
const startIcon = L.divIcon({ className:'start-pin', iconSize:[16,16] });
const hydrantIcon = L.divIcon({ className:'', html:'üßØ', iconSize:[20,20] });

function fmt(n){ return Intl.NumberFormat('en-SG',{maximumFractionDigits:1}).format(n); }
function haversine(a,b,c,d){const R=6371e3;const t=x=>x*Math.PI/180;const dLat=t(c-a), dLon=t(d-b);const A=Math.sin(dLat/2)**2+Math.cos(t(a))*Math.cos(t(c))*Math.sin(dLon/2)**2;return 2*R*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));}
function pickProp(props, keys, fallback='‚Äì'){ for(const k of keys){ if(props && props[k]!=null && props[k]!=='' ) return props[k]; } return fallback; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

function setStartPoint(latlng, label='üìç Start'){ if(startMarker) startMarker.remove(); startMarker=L.marker(latlng,{icon:startIcon}).addTo(map).bindPopup(`<b>${label}</b>`).openPopup(); }
map.on('click', e=>{ if(!clickMode) return; setStartPoint(e.latlng,'üìç Clicked'); clickMode=false; document.getElementById('clickBtn').classList.add('ghost'); });

document.getElementById('locateBtn').addEventListener('click',()=>{ if(!('geolocation' in navigator)) return alert('No geolocation, click on map instead.'); navigator.geolocation.getCurrentPosition(pos=>{ const ll=[pos.coords.latitude,pos.coords.longitude]; setStartPoint(ll,'üìç My location'); map.setView(ll,16); },()=>alert('Location failed.'),{enableHighAccuracy:true,timeout:10000,maximumAge:60000}); });

document.getElementById('clickBtn').addEventListener('click',()=>{ clickMode=!clickMode; document.getElementById('clickBtn').classList.toggle('ghost',!clickMode); });

document.getElementById('clearBtn').addEventListener('click',()=>{ nearestMarkers.forEach(m=>m.remove()); nearestMarkers=[]; if(routeLine){routeLine.remove();routeLine=null;} if(startMarker){startMarker.remove();startMarker=null;} document.getElementById('nearestList').innerHTML=''; });

document.getElementById('nearestBtn').addEventListener('click', findNearest);

L.Control.geocoder({ defaultMarkGeocode:false }).on('markgeocode', e=>{ setStartPoint(e.geocode.center, `üìç ${e.geocode.name}`); map.fitBounds(e.geocode.bbox); }).addTo(map);

async function loadGeoJSON(src){ const r=await fetch(src.url); if(!r.ok) throw new Error(`Load failed ${src.name}`); const gj=await r.json(); let count=0; const layer=L.geoJSON(gj,{ pointToLayer:(f,ll)=>L.marker(ll,{icon:hydrantIcon}), onEachFeature:(f,l)=>bindPopup(f,l,src.idField,src.addrField)}); layer.eachLayer(m=>{ const ll=m.getLatLng(); allPoints.push({lat:ll.lat, lon:ll.lng, marker:m, feature:m.feature}); count++; }); cluster.addLayer(layer); return count; }

function bindPopup(feat, layer, idField, addrField){ const id=idField?(feat.properties?.[idField]??'Hydrant'):pickProp(feat.properties,PROP_LABELS,'Hydrant'); const addr=addrField?(feat.properties?.[addrField]??''):pickProp(feat.properties,PROP_ADDR,''); const addrLine = addr? `<div style='color:#345'>${escapeHtml(addr)}</div>`:''; layer.bindPopup(`<b>${escapeHtml(id)}</b>${addrLine}`); }

async function boot(){ const status=document.getElementById('layerStatus'); status.textContent='Loading hydrants‚Ä¶'; const count=await loadGeoJSON(DATA_SOURCES[0]); map.addLayer(cluster); index=geokdbush.index(allPoints,p=>p.lon,p=>p.lat); status.innerHTML=`Loaded <b>${count}</b> hydrants.`; if(allPoints.length){ map.fitBounds(cluster.getBounds().pad(0.05)); } }

function findNearest(){ if(!startMarker) return alert('Set a start/incident point first.'); if(!index) return alert('Dataset not loaded yet.'); nearestMarkers.forEach(m=>m.remove()); nearestMarkers=[]; if(routeLine){routeLine.remove();routeLine=null;} const k=parseInt(document.getElementById('nearestCount').value,10); const o=startMarker.getLatLng(); const items=geokdbush.around(index,o.lng,o.lat,Math.max(k,1)); const list=document.getElementById('nearestList'); list.innerHTML=''; items.slice(0,k).forEach((p,i)=>{ const d=haversine(o.lat,o.lng,p.lat,p.lon); const numIcon=L.divIcon({className:'num-icon',html:String(i+1),iconSize:[24,24]}); const mk=L.marker([p.lat,p.lon],{icon:numIcon}).addTo(map); mk.bindPopup(`<b>Hydrant #${i+1}</b><div style='color:#345'>${escapeHtml(pickProp(p.feature.properties, PROP_LABELS, 'Hydrant'))}</div><div>${fmt(d)} m</div>`); nearestMarkers.push(mk); const el=document.createElement('div'); el.className='card'; el.innerHTML=`<div class='row'><div><span class='num'>${i+1}</span> ${escapeHtml(p.feature.properties['HYD_ID']||'Hydrant')}</div><div class='tag'>${fmt(d)} m</div></div><div class='row' style='margin-top:.35rem'><button class='goBtn' data-i='${i}'>Route</button><a target='_blank' rel='noopener' href='${gmapLink(o, L.latLng(p.lat,p.lon))}'>Open in Google Maps</a></div>`; list.appendChild(el); }); list.querySelectorAll('.goBtn').forEach(btn=>btn.addEventListener('click',e=>{ const idx=+e.currentTarget.getAttribute('data-i'); routeTo(items[idx]); })); }

function gmapLink(a,b){ return `https://www.google.com/maps/dir/?api=1&origin=${a.lat},${a.lng}&destination=${b.lat},${b.lng}&travelmode=driving`; }

async function routeTo(p){ const a=startMarker.getLatLng(), b=L.latLng(p.lat,p.lon); const url=`https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`; try{ const res=await fetch(url); if(!res.ok) throw new Error('Routing error'); const json=await res.json(); if(json.code!=='Ok'||!json.routes?.length) throw new Error('No route'); const r=json.routes[0]; if(routeLine) routeLine.remove(); routeLine=L.geoJSON(r.geometry,{style:{weight:5,opacity:.9}}).addTo(map); map.fitBounds(routeLine.getBounds().pad(0.1)); routeLine.bindPopup(`<b>Route</b><div>${fmt(r.distance/1000)} km ¬∑ ${fmt(r.duration/60)} min</div>`).openPopup(); } catch(e){ alert('OSRM demo may be rate-limited. Use the Google Maps link.'); console.warn(e); } }

boot();
</script>

<!--
Files to host together:
‚Ä¢ index.html (this file)
‚Ä¢ hydrants.geojson  ‚Üê generated from your CSV (download below)

Notes:
‚Ä¢ Label uses HYD_ID. Popup shows LOCATION when present. Icon is a red extinguisher emoji (üßØ).
‚Ä¢ To switch to a PNG/SVG icon, replace the divIcon with L.icon({iconUrl:'...png', iconSize:[w,h]}).
-->
</body>
</html>
